


# 프로젝트 소개
### 프로젝트 소개
본 프로젝트는 농산물 x-ray 이미지에서 결함을 검출할 수 있도록 시각화하는 프로젝트이다.  


![image](https://github.com/tjdans6342/Defect_Detection_Algorithm/assets/70836243/702b7a39-e77e-4a33-aea6-024a07769112)


<br><br>


### 프로젝트 배경
실제 농산물을 재배하는 환경에서 컨베이어 벨트 위의 농산물들의 결함을 실시간으로 검출할 수 있도록 도와준다.  


![image](https://github.com/tjdans6342/Defect_Detection_Algorithm/assets/70836243/c265a7d6-939f-44be-9528-8663468df7f3)


<br><br>


### 프로젝트 설계
본 프로젝트는 GUI 형태의 프로그램을 제공하며 아래와 같이 동작한다.  
- <b>Open 버튼</b>을 누르면 파일 탐색기가 열리며 이미지 파일을 여러 개 선택할 수 있다.  
- 이미지 파일을 선택하고 <b>detect 버튼</b>을 누르면 오른쪽에 결함 검출 알고리즘을 적용한 이미지가 나타난다.  
- 화면 아래의 인디케이터에 현재 몇 번째 이미지를 보고 있는지가 뜨며 (키보드) `A`키와 `D`키로 페이지를 이동할 수 있다.  

![image](https://github.com/tjdans6342/Defect_Detection_Algorithm/assets/70836243/67e7575b-f30f-49ae-b1c0-4f7815bd4aa6)

<br><br>

### 프로젝트 과정
- 추후에 추가할 예정



<br><br><br>

# 이미지 데이터 설명
농산물은 총 6가지 존재하고, 정상과 비정상으로 구별할 수 있으므로 모든 데이터는 12가지로 카테고리화할 수 있다.  
(농산물 = {`바나나`, `당근`, `양파`, `귤`, `피망`, `고구마`})  

![image](https://github.com/tjdans6342/Defect_Detection_Algorithm/assets/70836243/953d5762-7a15-4258-94b0-3ce6213d3ab7)

<br><br>

농산물 데이터의 이미지 크기는 `800 x 1024`, `400 x 1024` 두 가지 형태만 존재한다.  

![image](https://github.com/tjdans6342/Defect_Detection_Algorithm/assets/70836243/0c4122c4-9521-46b7-8055-8c83303c0934)

<br><br>

x-ray 이미지 데이터는 명암 영상으로 각 픽셀은 `0~255` 값을 가지며 밀도가 높을수록(검은색에 가까울수록) 픽셀 값이 작다.  

<br><br><br>


# 결함에 대한 정의
본 프로젝트에서 결함이란 `벌레가 파먹은 부분`, `썩은 부분`, `과일의 긁힌 자국` 등으로 정의한다.  
이러한 결함은 눈으로 봤을 때 x-ray 이미지 상에서 밀도가 낮게 보이는 특징이 있다.  

<br><br><br>

# 이미지 분석
이미지에서 찾을 수 있는 결함의 가장 큰 특징은 밀도가 다른 부분에 비해서 낮다는 특징이다.  
따라서, 밀도가 낮은 부분을 어떻게 하면 극대화할 수 있을까에 초점을 맞추며 이미지 분석을 진행했다.  


### 이진화 분석
이미지 밀도를 두 그룹으로 나누는 기법으로 명암 영상에서 할 수 있는 가장 기본적인 처리라고 할 수 있다.  
이진화할 임계값을 `0~255`사이로 지정하게 되면 두 그룹으로 나뉘게 되고 이러한 이진화를 한 이미지를 통해 분석했다.  

임계값을 `255`, `250`, `245`, `240`, `200`, `100`로 적용하고 분석한 결과, 이미지에는 배경 부분이 존재한다는 사실을 알 수 있었다.  
<b>이러한 배경을 제거하기 위해서 이진화 알고리즘과 침식과 팽창을 이용하여 입력 이미지를 처리해줬다.</b>  
(여러 시행을 통해 얻은 임계값은 `240`이며 노이즈를 제거하기 위해 침식 연산과 팽창 연산을 차례로 5번 적용해주었다.)  

<br><br>

### 히스토그램 분석
이미지들의 히스토그램을 분석한 결과 `0~255` 범위의 값이 골고루 쓰이지 않고 있다는 사실을 알 수 있었다.  
따라서, 이러한 값들을 더 잘 활용할 수 있도록 스트레칭이나 히스토그램 평활화 알고리즘에 대해 살펴보았다.  

![image](https://github.com/tjdans6342/Defect_Detection_Algorithm/assets/70836243/ea35d27b-ca7e-47ee-970a-8eb677811bce)

<br>

#### 스트레칭
스트레칭을 하게 되면 기존의 분포 모양을 유지하며 픽셀의 범위를 넓게 사용할 수 있다.  

![image](https://github.com/tjdans6342/Defect_Detection_Algorithm/assets/70836243/cca4e261-db86-4010-b77f-62e5313602fa)


<br>


#### 히스토그램 평활화
히스토그램 평활화는 픽셀의 범위를 넓게 사용할 수 있으나 분포 모양이 크게 변하게 된다.
![image](https://github.com/tjdans6342/Defect_Detection_Algorithm/assets/70836243/a1e49038-3ce3-467d-837e-10cd44d8f903)


<br>

#### 결론
스트레칭과 히스토그램 평활화 모두 픽셀의 범위를 늘려주는 것은 동일하다.  
하지만, 히스토그램 평활화 같은 경우에는 기존 히스토그램 분포의 모양이 크게 변하므로 정보 손실이 크다.  
(즉, 여러 픽셀의 값이 하나의 값으로 합쳐지거나 픽셀 간의 변환 폭이 달라서 적용하기에 적합하지 않다.)  

따라서, 이미지 결함 시각화 알고리즘을 적용할 이미지는 아래의 4번 과정까지 마친 결과 이미지를 사용한다.
1. 이진화의 임계값을 240으로 하여 배경과 물체의 영역을 분리  
2. 침식 5번과 팽창 5번을 하여 남아 있는 노이즈를 제거  
3. 이렇게 했을 때 남아 있는 부분만 농산물 이미지에서 사용 <br>
(즉, 이진화한 맵과 농산물 이미지 맵을 and 연산하여 농산물 이미지에서 노이즈를 제거한다는 의미)
4. 3의 결과 이미지에서 사용할 픽셀들을 대상으로 스트레칭


<br><br><br>



# 이미지 결함 시각화 알고리즘

이미지 결함을 시각화하기 위해서는 결함의 특징을 파악하고 그에 맞게끔 이미지를 처리해야 한다.  

<br>

### 이진화 알고리즘 이용
이미지에서 결함의 가장 큰 특징은 다른 부분에 비해서 밀도가 낮다는 특징이 있다.  
(정확히 말하면, 주변에 비해서 밀도가 낮다는 의미이다)  
따라서, 특정 임계값을 기준으로 이진화 알고리즘을 적용하여 밀도가 높은 부분과 낮은 부분으로 나누었다.
또한, 같은 부분이라 해도 픽셀의 값에 따라 색의 농도를 다르게 하여 더 잘 파악할 수 있도록 시각화했다.

![image](https://github.com/tjdans6342/Defect_Detection_Algorithm/assets/70836243/d5b01487-d95a-441c-92a2-e40c5862f672)

이러한 이미지는 사람이 보기에는 다소 가치 있는 정보를 제공하지만, 검출 알고리즘을 적용하기에는 정보가 다소 부족하다.
모든 농산물에 대해 여러 임계값(`0`, `10`, `20`, ..., `240`, `250`)을 적용해 보았으며 이는 주피터 노트북 파일을 참조하기 바란다.


<br><br>

### 지역 정보 이용
이미지에서 결함의 특징을 단순히 밀도가 낮다고 치부하는 것은 농산물 이미지의 형태를 전혀 고려하지 못한 방법이다.  

이미지의 결함의 더욱 구체적인 특징은 주변 영역에 비해서 밀도가 낮다는 특징이 있다.
여기서는 현재 픽셀의 색을 결정할 때(색은 해당 픽셀이 결함일 가능성을 의미) 주변 픽셀의 정보를 이용하여 시각화했다.

여기서 사용한 알고리즘의 원리는 아래와 같다.  
- 어떤 픽셀의 색을 결정할 때 `5 x 5` 의 평균적인 밀도와 `40 x 40` 의 평균적인 밀도를 구한다.  
- 두 값을 비교하여 `5 x 5` 부분의 밀도가 더 낮으면 빨간색, 그렇지 않으면 파란색으로 시각화했다.


![image](https://github.com/tjdans6342/Defect_Detection_Algorithm/assets/70836243/93e72960-115f-4589-9756-d54128536198)

시각화한 이미지를 보면, 이진화 알고리즘을 이용한 시각화보다 결함 부분을 더 잘 분리한 것을 확인할 수 있다.  


<br><br>



### 지역 정보 이용 + 영역의 경계 정보 이용
가나다라마바사

![image](https://github.com/tjdans6342/Defect_Detection_Algorithm/assets/70836243/664d5150-6bf8-489a-b4af-296a42655539)













